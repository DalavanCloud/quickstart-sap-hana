{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "(0008) Deploy SAP HANA on AWS",
    "Parameters": {
        "VPCID": {
            "Type": "AWS::EC2::VPC::Id",
            "Description": "The existing Amazon VPC where you want to deploy SAP HANA.",
            "Default": "vpc-xxxxxxxx",
            "AllowedPattern": "vpc-[0-9a-z]{8}"
        },
        "PrivSubCIDR": {
            "Description": "CIDR block of the private subnet where SAP HANA will be deployed.",
            "Type": "String",
            "Default": "10.0.1.0/24",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"
        },
        "DMZCIDR": {
            "Description": "CIDR block of the public DMZ subnet where BASTION Host / NAT Gateway exist.",
            "Type": "String",
            "Default": "10.0.2.0/24",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"
        },
        "RemoteAccessCIDR": {
            "Description": "CIDR block from where you want to access your RDP instance.",
            "Type": "String",
            "MinLength": "9",
            "MaxLength": "18",
            "Default": "0.0.0.0/0",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "This must be a valid CIDR range in the format x.x.x.x/x."
        },
        "HANASubnet": {
            "Type": "AWS::EC2::Subnet::Id",
            "Description": "The existing private subnet in your VPC where you want to deploy SAP HANA.",
            "Default": "subnet-xxxxxxxx",
            "AllowedPattern": "subnet-[0-9a-z]{8}"
        },
        "DMZSubnet": {
            "Type": "AWS::EC2::Subnet::Id",
            "Description": "The existing public subnet in your VPC where you want to deploy the optional RDP instance.",
            "Default": "subnet-xxxxxxxx",
            "AllowedPattern": "subnet-[0-9a-z]{8}"
        },
        "DomainName": {
            "Type": "String",
            "Description": "Name to use for fully qualified domain names.",
            "Default": "local"
        },
        "HANAMasterHostname": {
            "Type": "String",
            "Description": "Host name to use for SAP HANA master node (DNS short name).",
            "Default": "imdbmaster"
        },
        "HANAWorkerHostname": {
            "Type": "String",
            "Description": "Host name to use for SAP HANA worker node(s) (DNS short name).",
            "Default": "imdbworker"
        },
        "PlacementGroupName": {
            "Type": "String",
            "Default": "",
            "Description": "Name of an existing placement group where SAP HANA should be deployed (for scale-out deployments."
        },
        "PrivateBucket": {
            "Description": "Main build bucket where templates and scripts are located.",
            "Type": "String",
            "Default": "quickstart-reference/sap/hana/latest"
        },
        "KeyName": {
            "Type": "AWS::EC2::KeyPair::KeyName",
            "Default": "home",
            "Description": "Name of an existing Amazon EC2 key pair. All instances will launch with this key pair."
        },
        "HANAInstallMedia": {
            "Description": "Full path to Amazon S3 location of SAP HANA software files (e.g., s3://myhanabucket/sap-hana-sps11/).",
            "Default": "",
            "Type": "String"
        },
        "AutoRecovery": {
            "Type": "String",
            "Description": "Enable (Yes) or disable (No) automatic recovery feature for SAP HANA nodes.",
            "Default": "Yes",
            "AllowedValues": [
                "Yes",
                "No"
            ]
        },
        "Encryption": {
            "Type": "String",
            "Description": "Enable (Yes) or disable (No) encryption on EBS volumes.",
            "Default": "No",
            "AllowedValues": [
                "Yes",
                "No"
            ]
        },
        "VolumeType": {
            "Type": "String",
            "Description": "EBS volume type: General Purpose SSD (gp2) or Provisioned IOPS SSD (io1).",
            "Default": "gp2",
            "AllowedValues": [
                "gp2",
                "io1"
            ]
        },
        "MyOS": {
            "Type": "String",
            "Description": "Operating system (SLES or RHEL) and version for master and worker nodes.",
            "Default": "SuSELinux12SP1",
            "AllowedValues": [
                "SuSELinux11SP4",
                "SuSELinux12",
                "SuSELinux12SP1",
                "RedHatLinux66",
                "RedHatLinux67"
            ]
        },
        "InstallRDPInstance": {
            "Type": "String",
            "Description": "Install (Yes) or don't install (No) optional Windows RDP instance.",
            "Default": "No",
            "AllowedValues": [
                "Yes",
                "No"
            ]
        },
        "InstallHANA": {
            "Type": "String",
            "Description": "Install (Yes) or don't install (No) HANA. When set to No, only AWS infrastructure is provisioned.",
            "Default": "Yes",
            "AllowedValues": [
                "Yes",
                "No"
            ]
        },
        "RDPInstanceType": {
            "Type": "String",
            "Description": "Instance type for Windows RDP instance.",
            "Default": "c4.large",
            "AllowedValues": [
                "c4.large",
                "c4.xlarge",
                "m4.large",
                "m4.xlarge"
            ]
        },
        "MyInstanceType": {
            "Type": "String",
            "Description": "Instance type for SAP HANA host.",
            "Default": "r3.2xlarge",
            "AllowedValues": [
                "r3.8xlarge",
                "r3.4xlarge",
                "r3.2xlarge",
                "x1.16xlarge",
                "x1.32xlarge"
            ]
        },
        "HostCount": {
            "Type": "Number",
            "Description": "Total number of SAP HANA nodes you want to deploy in the SAP HANA cluster.",
            "Default": "1",
            "MinValue": "1",
            "MaxValue": "5"
        },
        "SID": {
            "Type": "String",
            "Default": "HDB",
            "Description": "SAP HANA system ID for installation and setup.",
            "AllowedPattern": "([A-Z]{1}[0-9A-Z]{2})",
            "ConstraintDescription": "This value must consist of 3 characters."
        },
        "SAPInstanceNum": {
            "Type": "String",
            "Default": "00",
            "Description": "SAP HANA instance number to use for installation and setup, and to open ports for security groups.",
            "AllowedPattern": "([0-9]{1}[0-7]{1})"
        },
        "HANAMasterPass": {
            "Type": "String",
            "Description": "SAP HANA password to use during installation.",
            "NoEcho": "true",
            "MinLength": "8",
            "AllowedPattern": "^(?=.*?[a-z])(?=.*?[A-Z])(?=.*[0-9]).*",
            "ConstraintDescription": "This must be at least 8 characters, including uppercase, lowercase, and numeric values."
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Existing network infrastructure details"
                    },
                    "Description": {
                        "default": ""
                    },
                    "Parameters": [
                        "VPCID",
                        "HANASubnet",
                        "DMZSubnet",
                        "PrivSubCIDR",
                        "DMZCIDR"
                    ]
                },
                {
                    "Label": {
                        "default": "Server and storage configuration"
                    },
                    "Description": {
                        "default": ""
                    },
                    "Parameters": [
                        "MyOS",
                        "MyInstanceType",
                        "HostCount",
                        "AutoRecovery",
                        "KeyName",
                        "VolumeType",
                        "Encryption"
                    ]
                },
                {
                    "Label": {
                        "default": "SAP HANA database configuration"
                    },
                    "Description": {
                        "default": ""
                    },
                    "Parameters": [
                        "DomainName",
                        "HANAMasterHostname",
                        "HANAWorkerHostname",
                        "SID",
                        "SAPInstanceNum",
                        "HANAMasterPass",
                        "HANAInstallMedia",
                        "InstallHANA"
                    ]
                },
                {
                    "Label": {
                        "default": "Optional configuration"
                    },
                    "Description": {
                        "default": ""
                    },
                    "Parameters": [
                        "PlacementGroupName",
                        "InstallRDPInstance",
                        "RDPInstanceType",
                        "RemoteAccessCIDR"
                    ]
                },
                {
                    "Label": {
                        "default": "Advanced configuration (Do not modify unless directed by AWS Support)"
                    },
                    "Description": {
                        "default": ""
                    },
                    "Parameters": [
                        "PrivateBucket"
                    ]
                }
            ],
            "ParameterLabels": {
                "VPCID": {
                    "default": "Choose VPC ID"
                },
                "PrivSubCIDR": {
                    "default": "Enter CIDR block for private subnet"
                },
                "DMZSubnet": {
                    "default": "Choose public subnet"
                },
                "DMZCIDR": {
                    "default": "Enter CIDR block for public subnet"
                },
                "HANASubnet": {
                    "default": "Choose private subnet"
                },
                "RemoteAccessCIDR": {
                    "default": "Enter CIDR block for RDP access"
                },
                "SnapShotID": {
                    "default": "Enter snapshot ID"
                },
                "DomainName": {
                    "default": "Enter domain name"
                },
                "HANAMasterHostname": {
                    "default": "Enter SAP HANA master host name"
                },
                "HANAWorkerHostname": {
                    "default": "Enter SAP HANA worker host name"
                },
                "HANAInstallMedia": {
                    "default": "Enter Amazon S3 URL for SAP HANA software"
                },
                "PlacementGroupName": {
                    "default": "Enter optional placement group name"
                },
                "PrivateBucket": {
                    "default": "Enter private bucket"
                },
                "KeyName": {
                    "default": "Choose key pair"
                },
                "AutoRecovery": {
                    "default": "Would you like to turn on automatic recovery?"
                },
                "InstallRDPInstance": {
                    "default": "Do you need a Windows RDP instance?"
                },
                "InstallHANA": {
                    "default": "Install SAP HANA software?"
                },
                "Encryption": {
                    "default": "Would you like to turn on encryption?"
                },
                "VolumeType": {
                    "default": "Choose storage volume type"
                },
                "MyOS": {
                    "default": "Choose operating system for SAP HANA"
                },
                "MyInstanceType": {
                    "default": "Choose instance type for SAP HANA"
                },
                "HostCount": {
                    "default": "Enter number of SAP HANA hosts"
                },
                "SID": {
                    "default": "Enter SAP HANA system ID"
                },
                "SAPInstanceNum": {
                    "default": "Enter SAP HANA instance number"
                },
                "HANAMasterPass": {
                    "default": "Enter SAP HANA password"
                },
                "RDPInstanceType": {
                    "default": "Choose instance type for RDP host"
                }
            }
        }
    },
    "Conditions": {
        "TwoOrMoreNodes": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        "2",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                },
                {
                    "Fn::Equals": [
                        "3",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                },
                {
                    "Fn::Equals": [
                        "4",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                },
                {
                    "Fn::Equals": [
                        "5",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                },
                {
                    "Fn::Equals": [
                        "6",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                }
            ]
        },
        "ThreeOrMoreNodes": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        "3",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                },
                {
                    "Fn::Equals": [
                        "4",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                },
                {
                    "Fn::Equals": [
                        "5",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                },
                {
                    "Fn::Equals": [
                        "6",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                }
            ]
        },
        "FourOrMoreNodes": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        "4",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                },
                {
                    "Fn::Equals": [
                        "5",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                },
                {
                    "Fn::Equals": [
                        "6",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                }
            ]
        },
        "FiveOrMoreNodes": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        "5",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                },
                {
                    "Fn::Equals": [
                        "6",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                }
            ]
        },
        "SixOrMoreNodes": {
            "Fn::Or": [
                {
                    "Fn::Equals": [
                        "6",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                },
                {
                    "Fn::Equals": [
                        "7",
                        {
                            "Ref": "HostCount"
                        }
                    ]
                }
            ]
        },
        "AutoRecoveryWorker1": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        "Yes",
                        {
                            "Ref": "AutoRecovery"
                        }
                    ]
                },
                {
                    "Condition": "TwoOrMoreNodes"
                }
            ]
        },
        "AutoRecoveryWorker2": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        "Yes",
                        {
                            "Ref": "AutoRecovery"
                        }
                    ]
                },
                {
                    "Condition": "ThreeOrMoreNodes"
                }
            ]
        },
        "AutoRecoveryWorker3": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        "Yes",
                        {
                            "Ref": "AutoRecovery"
                        }
                    ]
                },
                {
                    "Condition": "FourOrMoreNodes"
                }
            ]
        },
        "AutoRecoveryWorker4": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        "Yes",
                        {
                            "Ref": "AutoRecovery"
                        }
                    ]
                },
                {
                    "Condition": "FiveOrMoreNodes"
                }
            ]
        },
        "AutoRecoveryWorker5": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        "Yes",
                        {
                            "Ref": "AutoRecovery"
                        }
                    ]
                },
                {
                    "Condition": "SixOrMoreNodes"
                }
            ]
        },
        "AutoRecoveryMaster": {
            "Fn::Equals": [
                {
                    "Ref": "AutoRecovery"
                },
                "Yes"
            ]
        },
        "NeedWindowsInstance": {
            "Fn::Equals": [
                {
                    "Ref": "InstallRDPInstance"
                },
                "Yes"
            ]
        },
        "PlacementGroupNull": {
            "Fn::Equals": [
                {
                    "Ref": "PlacementGroupName"
                },
                ""
            ]
        },
        "UseEncryption": {
            "Fn::Equals": [
                {
                    "Ref": "Encryption"
                },
                "Yes"
            ]
        },
        "IfUseSLES": {
            "Fn::Equals": [
                {
                    "Fn::FindInMap": [
                        "SAPAMINameMap",
                        {
                            "Ref": "MyOS"
                        },
                        "Code"
                    ]
                },
                "SLES"
            ]
        }
    },
    "Mappings": {
        "SAPAMINameMap": {
            "RedHatLinux66": {
                "Code": "RHEL66SAPHVM"
            },
            "RedHatLinux67": {
                "Code": "RHEL67SAPHVM"
            },
            "SuSELinux11SP4": {
                "Code": "SLES11SP4HVM"
            },
            "SuSELinux12": {
                "Code": "SLES12HVM"
            },
            "SuSELinux12SP1": {
                "Code": "SLES12SP1HVM"
            },
            "SuSELinux12SP1ForSAP": {
                "Code": "SLES12SP1SAPHVM"
            }
        },
        "AWSAMIRegionMap": {
            "AMI": {
                "RHEL66SAPHVM": "RHEL-6.6_HVM_GA-SAP-20150430-x86_64-2-Hourly2-GP2-b676039c-a4f8-4be7-9866-c804b1ade684-ami-905a54f8.2",
                "RHEL67SAPHVM": "SAP-6.7_HVM-20160412-x86_64-1-Hourly2-GP2-b676039c-a4f8-4be7-9866-c804b1ade684-ami-afbdaec5.3",
                "SLES11SP4HVM": "suse-sles-11-sp4-v20160804-hvm-ssd-x86_64",
                "SLES12HVM": "suse-sles-12-v20151113-hvm-ssd-x86_64",
                "SLES12SP1HVM": "suse-sles-12-sp1-v20161021-hvm-ssd-x86_64",
                "SLES12SP1SAPHVM": "suse-sles-sap-12-sp1-v20160805-hvm-ssd-x86_64-2f28c0e5-af3e-4d22-95f1-6c1af645c209-ami-334a0024.3",
                "WS2012R2": "Windows_Server-2012-R2_RTM-English-64Bit-Base-2016.10.12"
            },
            "ap-northeast-1": {
                "RHEL66SAPHVM": "ami-dce538dc",
                "RHEL67SAPHVM": "ami-bded38dc",
                "SLES11SP4HVM": "ami-1c73b47d",
                "SLES12HVM": "ami-0a705064",
                "SLES12SP1HVM": "ami-d94fe9b8",
                "SLES12SP1SAPHVM": "ami-c6d770a7",
                "WS2012R2": "ami-7c449e1d"
            },
            "ap-northeast-2": {
                "RHEL66SAPHVM": "ami-0d9d5363",
                "RHEL67SAPHVM": "ami-8414c1ea",
                "SLES11SP4HVM": "ami-0b20ea65",
                "SLES12SP1HVM": "ami-1ced3972",
                "SLES12SP1SAPHVM": "ami-3ef72350",
                "WS2012R2": "ami-4fd30721"
            },
            "ap-south-1": {
                "SLES11SP4HVM": "ami-12285d7d",
                "SLES12SP1HVM": "ami-985226f7",
                "SLES12SP1SAPHVM": "ami-2365114c",
                "WS2012R2": "ami-f90f7b96"
            },
            "ap-southeast-1": {
                "RHEL66SAPHVM": "ami-a6d5eef4",
                "RHEL67SAPHVM": "ami-6c25fe0f",
                "SLES11SP4HVM": "ami-81d806e2",
                "SLES12HVM": "ami-2620e645",
                "SLES12SP1HVM": "ami-163d9b75",
                "SLES12SP1SAPHVM": "ami-0a903669",
                "WS2012R2": "ami-2b309748"
            },
            "ap-southeast-2": {
                "RHEL66SAPHVM": "ami-a74c349d",
                "RHEL67SAPHVM": "ami-8a6051e9",
                "SLES11SP4HVM": "ami-2f7f4b4c",
                "SLES12HVM": "ami-96ecb2f5",
                "SLES12SP1HVM": "ami-e32b1680",
                "SLES12SP1SAPHVM": "ami-5985b73a",
                "WS2012R2": "ami-74043617"
            },
            "eu-central-1": {
                "RHEL66SAPHVM": "ami-4c073e51",
                "RHEL67SAPHVM": "ami-b90bf8d6",
                "SLES11SP4HVM": "ami-68788f07",
                "SLES12HVM": "ami-d7485abb",
                "SLES12SP1HVM": "ami-59699036",
                "SLES12SP1SAPHVM": "ami-8fff06e0",
                "WS2012R2": "ami-0c34ca63"
            },
            "eu-west-1": {
                "RHEL66SAPHVM": "ami-99126fee",
                "RHEL67SAPHVM": "ami-a9d7aada",
                "SLES11SP4HVM": "ami-0f18717c",
                "SLES12HVM": "ami-c1f328b2",
                "SLES12SP1HVM": "ami-b197d9c2",
                "SLES12SP1SAPHVM": "ami-7b317e08",
                "WS2012R2": "ami-55084526"
            },
            "sa-east-1": {
                "RHEL66SAPHVM": "ami-b3e666ae",
                "RHEL67SAPHVM": "ami-87e272eb",
                "SLES11SP4HVM": "ami-c61483aa",
                "SLES12HVM": "ami-319e245d",
                "SLES12SP1HVM": "ami-ce3aa7a2",
                "SLES12SP1SAPHVM": "ami-e874e984",
                "WS2012R2": "ami-42ee732e"
            },
            "us-east-1": {
                "RHEL66SAPHVM": "ami-23ea0648",
                "RHEL67SAPHVM": "ami-819ce996",
                "SLES11SP4HVM": "ami-0434a713",
                "SLES12HVM": "ami-f2d5ad98",
                "SLES12SP1HVM": "ami-1eeab909",
                "SLES12SP1SAPHVM": "ami-06277611",
                "WS2012R2": "ami-3f0c4628"
            },
            "us-east-2": {
                "RHEL66SAPHVM": "ami-23ea0648",
                "RHEL67SAPHVM": "ami-819ce996",
                "SLES11SP4HVM": "ami-4af2a92f",
                "SLES12HVM": "ami-f2d5ad98",
                "SLES12SP1HVM": "ami-85075de0",
                "SLES12SP1SAPHVM": "ami-47154f22",
                "WS2012R2": "ami-de164cbb"
            },
            "us-west-1": {
                "RHEL66SAPHVM": "ami-3311fa77",
                "RHEL67SAPHVM": "ami-92561af2",
                "SLES11SP4HVM": "ami-2fe0a04f",
                "SLES12HVM": "ami-b56b05d5",
                "SLES12SP1HVM": "ami-a12962c1",
                "SLES12SP1SAPHVM": "ami-55c08835",
                "WS2012R2": "ami-123c7472"
            },
            "us-west-2": {
                "RHEL66SAPHVM": "ami-15e1df25",
                "RHEL67SAPHVM": "ami-3faa7a5f",
                "SLES11SP4HVM": "ami-e331f883",
                "SLES12HVM": "ami-d51607b4",
                "SLES12SP1HVM": "ami-7fa2061f",
                "SLES12SP1SAPHVM": "ami-1b81247b",
                "WS2012R2": "ami-b871aad8"
            }
        }
    },
    "Outputs": {
        "HANAMasterInstanceIP": {
            "Description": "HANA Master Node IP Address",
            "Value": {
                "Fn::GetAtt": [
                    "HANAMasterInstance",
                    "PrivateIp"
                ]
            }
        },
        "HANAMasterSecurityGroup": {
            "Description": "Security Group created for the SAP HANA Master node",
            "Value": {
                "Fn::GetAtt": [
                    "HANASecurityGroup",
                    "GroupId"
                ]
            }
        }
    },
    "Resources": {
        "DeploymentInterruptQ": {
            "Type": "AWS::SQS::Queue",
            "Properties": {
                "DelaySeconds": 0,
                "VisibilityTimeout": 0
            }
        },
        "HANAMasterInterface": {
            "Type": "AWS::EC2::NetworkInterface",
            "Properties": {
                "Description": "Network Interface for HANA Master",
                "SubnetId": {
                    "Ref": "HANASubnet"
                },
                "GroupSet": [
                    {
                        "Ref": "HANASecurityGroup"
                    }
                ],
                "SourceDestCheck": "true",
                "Tags": [
                    {
                        "Key": "Network",
                        "Value": "Private"
                    }
                ]
            }
        },
        "HANAMasterCloneInterface": {
            "Type": "AWS::EC2::NetworkInterface",
            "Properties": {
                "Description": "Network Interface for HANA Master Clone (PreCheck)",
                "SubnetId": {
                    "Ref": "HANASubnet"
                },
                "GroupSet": [
                    {
                        "Ref": "HANASecurityGroup"
                    }
                ],
                "SourceDestCheck": "true",
                "Tags": [
                    {
                        "Key": "Network",
                        "Value": "Private"
                    }
                ]
            }
        },
        "HANAWorker1Interface": {
            "Type": "AWS::EC2::NetworkInterface",
            "Condition": "TwoOrMoreNodes",
            "Properties": {
                "SubnetId": {
                    "Ref": "HANASubnet"
                },
                "Description": "Interface for HANA Worker 1",
                "GroupSet": [
                    {
                        "Ref": "HANASlaveSG"
                    }
                ],
                "SourceDestCheck": "true",
                "Tags": [
                    {
                        "Key": "Network",
                        "Value": "Private"
                    }
                ]
            }
        },
        "HANAWorker2Interface": {
            "Type": "AWS::EC2::NetworkInterface",
            "Condition": "ThreeOrMoreNodes",
            "Properties": {
                "SubnetId": {
                    "Ref": "HANASubnet"
                },
                "Description": "Interface for HANA Worker 2",
                "GroupSet": [
                    {
                        "Ref": "HANASlaveSG"
                    }
                ],
                "SourceDestCheck": "true",
                "Tags": [
                    {
                        "Key": "Network",
                        "Value": "Private"
                    }
                ]
            }
        },
        "HANAWorker3Interface": {
            "Type": "AWS::EC2::NetworkInterface",
            "Condition": "FourOrMoreNodes",
            "Properties": {
                "SubnetId": {
                    "Ref": "HANASubnet"
                },
                "Description": "Interface for HANA Worker 3",
                "GroupSet": [
                    {
                        "Ref": "HANASlaveSG"
                    }
                ],
                "SourceDestCheck": "true",
                "Tags": [
                    {
                        "Key": "Network",
                        "Value": "Private"
                    }
                ]
            }
        },
        "HANAWorker4Interface": {
            "Type": "AWS::EC2::NetworkInterface",
            "Condition": "FiveOrMoreNodes",
            "Properties": {
                "SubnetId": {
                    "Ref": "HANASubnet"
                },
                "Description": "Interface for HANA Worker 4",
                "GroupSet": [
                    {
                        "Ref": "HANASlaveSG"
                    }
                ],
                "SourceDestCheck": "true",
                "Tags": [
                    {
                        "Key": "Network",
                        "Value": "Private"
                    }
                ]
            }
        },
        "HANAWorker5Interface": {
            "Type": "AWS::EC2::NetworkInterface",
            "Condition": "SixOrMoreNodes",
            "Properties": {
                "SubnetId": {
                    "Ref": "HANASubnet"
                },
                "Description": "Interface for HANA Worker 5",
                "GroupSet": [
                    {
                        "Ref": "HANASlaveSG"
                    }
                ],
                "SourceDestCheck": "true",
                "Tags": [
                    {
                        "Key": "Network",
                        "Value": "Private"
                    }
                ]
            }
        },
        "HANASecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Enable external access to the HANA Master and allow communication from slave instances",
                "VpcId": {
                    "Ref": "VPCID"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": {
                            "Ref": "PrivSubCIDR"
                        },
                        "FromPort": "1",
                        "ToPort": "65535"
                    },
                    {
                        "IpProtocol": "udp",
                        "CidrIp": {
                            "Ref": "PrivSubCIDR"
                        },
                        "FromPort": "111",
                        "ToPort": "111"
                    },
                    {
                        "IpProtocol": "udp",
                        "CidrIp": {
                            "Ref": "PrivSubCIDR"
                        },
                        "FromPort": "2049",
                        "ToPort": "2049"
                    },
                    {
                        "IpProtocol": "udp",
                        "CidrIp": {
                            "Ref": "PrivSubCIDR"
                        },
                        "FromPort": "4000",
                        "ToPort": "4002"
                    },
                    {
                        "IpProtocol": "icmp",
                        "CidrIp": {
                            "Ref": "PrivSubCIDR"
                        },
                        "FromPort": "-1",
                        "ToPort": "-1"
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        },
                        "FromPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "5",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "13"
                                ]
                            ]
                        },
                        "ToPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "5",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "14"
                                ]
                            ]
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        },
                        "FromPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "3",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "15"
                                ]
                            ]
                        },
                        "ToPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "3",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "15"
                                ]
                            ]
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        },
                        "FromPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "3",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "17"
                                ]
                            ]
                        },
                        "ToPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "3",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "17"
                                ]
                            ]
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        },
                        "FromPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "80",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    ""
                                ]
                            ]
                        },
                        "ToPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "80",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    ""
                                ]
                            ]
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        },
                        "FromPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "3",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "09"
                                ]
                            ]
                        },
                        "ToPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "3",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "09"
                                ]
                            ]
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        },
                        "FromPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "43",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    ""
                                ]
                            ]
                        },
                        "ToPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "43",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    ""
                                ]
                            ]
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        },
                        "FromPort": "8080",
                        "ToPort": "8080"
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        },
                        "FromPort": "8443",
                        "ToPort": "8443"
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        },
                        "FromPort": "1128",
                        "ToPort": "1128"
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        },
                        "FromPort": "1129",
                        "ToPort": "1129"
                    },
                    {
                        "IpProtocol": "tcp",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        },
                        "FromPort": "22",
                        "ToPort": "22"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "CidrIp": "0.0.0.0/0",
                        "FromPort": "1",
                        "ToPort": "65535"
                    }
                ]
            }
        },
        "HANASlaveSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Condition": "TwoOrMoreNodes",
            "Properties": {
                "GroupDescription": "Enable communication between the master and slave instances",
                "VpcId": {
                    "Ref": "VPCID"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "1",
                        "ToPort": "65535",
                        "CidrIp": {
                            "Ref": "PrivSubCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "5",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "13"
                                ]
                            ]
                        },
                        "ToPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "5",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "14"
                                ]
                            ]
                        },
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "3",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "15"
                                ]
                            ]
                        },
                        "ToPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "3",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "15"
                                ]
                            ]
                        },
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "3",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "17"
                                ]
                            ]
                        },
                        "ToPort": {
                            "Fn::Join": [
                                "",
                                [
                                    "3",
                                    {
                                        "Ref": "SAPInstanceNum"
                                    },
                                    "17"
                                ]
                            ]
                        },
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "1128",
                        "ToPort": "1129",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "8080",
                        "ToPort": "8080",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "8443",
                        "ToPort": "8443",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        }
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": {
                            "Ref": "DMZCIDR"
                        }
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "-1",
                        "FromPort": "1",
                        "ToPort": "65535",
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "HANAIAMRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "HANA-Backup",
                        "PolicyDocument": {
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:*",
                                        "ec2:*",
                                        "ec2:Describe*",
                                        "ec2:AttachNetworkInterface",
                                        "ec2:AttachVolume",
                                        "ec2:CreateTags",
                                        "ec2:CreateVolume",
                                        "ec2:RunInstances",
                                        "ec2:StartInstances",
                                        "ec2:DeleteVolume",
                                        "ec2:CreateSecurityGroup",
                                        "ec2:CreateSnapshot"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": "cloudwatch:GetMetricStatistics",
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "sqs:*",
                                        "dynamodb:*",
                                        "dynamodb:Scan",
                                        "dynamodb:Query",
                                        "dynamodb:GetItem",
                                        "dynamodb:BatchGetItem",
                                        "dynamodb:UpdateTable",
                                        "cloudformation:DescribeStacks",
                                        "cloudformation:DescribeStackEvents",
                                        "cloudformation:DescribeStackResource",
                                        "cloudformation:DescribeStackResources",
                                        "cloudformation:GetTemplate",
                                        "cloudformation:List*"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "HANAIAMProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "HANAIAMRole"
                    }
                ]
            }
        },
        "WaitForHANAInstall": {
            "Type": "AWS::CloudFormation::WaitCondition",
            "DependsOn": "HANAMasterInstance",
            "Properties": {
                "Handle": {
                    "Ref": "WaitForMasterInstallWaitHandle"
                },
                "Timeout": "7200"
            }
        },
        "WaitForMasterInstallWaitHandle": {
            "Type": "AWS::CloudFormation::WaitConditionHandle",
            "Properties": {}
        },
        "RDPInstanceRootRole": {
            "Condition": "NeedWindowsInstance",
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "root",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "s3:*",
                                        "ec2:Describe*",
                                        "ec2:AttachNetworkInterface",
                                        "ec2:AttachVolume",
                                        "ec2:CreateTags",
                                        "ec2:CreateVolume",
                                        "ec2:DeleteVolume",
                                        "ec2:RunInstances",
                                        "ec2:StartInstances",
                                        "ec2:CreateSecurityGroup",
                                        "ec2:CreatePlacementGroup",
                                        "ec2:CreateSnapshot"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Action": [
                                        "sqs:*"
                                    ],
                                    "Effect": "Allow",
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudformation:CreateStack",
                                        "cloudformation:DeleteStack",
                                        "cloudformation:DescribeStack",
                                        "cloudformation:EstimateTemplateCost",
                                        "cloudformation:ValidateTemplate",
                                        "cloudformation:DescribeStackEvents",
                                        "cloudformation:DescribeStackResource",
                                        "cloudformation:DescribeStackResources",
                                        "cloudformation:DescribeStacks"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:CreateRole"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:PutRolePolicy"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:CreateInstanceProfile"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:AddRoleToInstanceProfile"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:PassRole"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:RevokeSecurityGroupEgress"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:AuthorizeSecurityGroupEgress"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:AuthorizeSecurityGroupIngress"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:CreateNetworkInterface"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:ModifyNetworkInterfaceAttribute"
                                    ],
                                    "Resource": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "RDPProfile": {
            "Condition": "NeedWindowsInstance",
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "RDPInstanceRootRole"
                    }
                ]
            }
        },
        "RDPSecurityGroup": {
            "Condition": "NeedWindowsInstance",
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "RDP Instance security group",
                "VpcId": {
                    "Ref": "VPCID"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "3389",
                        "ToPort": "3389",
                        "CidrIp": {
                            "Ref": "RemoteAccessCIDR"
                        }
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "1",
                        "ToPort": "65535",
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "RDPEIP": {
            "Condition": "NeedWindowsInstance",
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc"
            }
        },
        "RDPInterface": {
            "Condition": "NeedWindowsInstance",
            "Type": "AWS::EC2::NetworkInterface",
            "Properties": {
                "SubnetId": {
                    "Ref": "DMZSubnet"
                },
                "Description": "Interface for RDP Instance",
                "GroupSet": [
                    {
                        "Ref": "RDPSecurityGroup"
                    }
                ],
                "SourceDestCheck": "true",
                "Tags": [
                    {
                        "Key": "Network",
                        "Value": "Public"
                    }
                ]
            }
        },
        "AssociateRDPEIP": {
            "Condition": "NeedWindowsInstance",
            "Type": "AWS::EC2::EIPAssociation",
            "Properties": {
                "AllocationId": {
                    "Fn::GetAtt": [
                        "RDPEIP",
                        "AllocationId"
                    ]
                },
                "NetworkInterfaceId": {
                    "Ref": "RDPInterface"
                }
            }
        },
        "RDPInstance": {
            "Condition": "NeedWindowsInstance",
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "NetworkInterfaces": [
                    {
                        "NetworkInterfaceId": {
                            "Ref": "RDPInterface"
                        },
                        "DeviceIndex": "0"
                    }
                ],
                "KeyName": {
                    "Ref": "KeyName"
                },
                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSAMIRegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "WS2012R2"
                    ]
                },
                "IamInstanceProfile": {
                    "Ref": "RDPProfile"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "SAP RDP Instance (Public Subnet)"
                    }
                ],
                "InstanceType": {
                    "Ref": "RDPInstanceType"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "<powershell>\n",
                                "Set-ExecutionPolicy RemoteSigned -Force \n",
                                "Start-Process -FilePath msiexec -ArgumentList /i,  \"http://sdk-for-net.amazonwebservices.com/latest/AWSToolsAndSDKForNet.msi\", /passive -wait \n",
                                "</powershell>"
                            ]
                        ]
                    }
                }
            }
        },
        "HANAMasterInstance": {
            "Type": "AWS::EC2::Instance",
            "Metadata": {
                "HostRole": "Master"
            },
            "Properties": {
                "NetworkInterfaces": [
                    {
                        "NetworkInterfaceId": {
                            "Ref": "HANAMasterInterface"
                        },
                        "DeviceIndex": "0"
                    }
                ],
                "PlacementGroupName": {
                    "Fn::If": [
                        "PlacementGroupNull",
                        {
                            "Ref": "AWS::NoValue"
                        },
                        {
                            "Ref": "PlacementGroupName"
                        }
                    ]
                },
                "KeyName": {
                    "Ref": "KeyName"
                },
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "50",
                            "VolumeType": "gp2"
                        }
                    }
                ],
                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSAMIRegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        {
                            "Fn::FindInMap": [
                                "SAPAMINameMap",
                                {
                                    "Ref": "MyOS"
                                },
                                "Code"
                            ]
                        }
                    ]
                },
                "IamInstanceProfile": {
                    "Ref": "HANAIAMProfile"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "SAP HANA Master"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -xv\n",
                                "exec 3>&1 1>>/root/install/misc.log 2>&1 \n",
                                "hostname ",
                                {
                                    "Ref": "HANAMasterHostname"
                                },
                                "\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        ".",
                                        [
                                            {
                                                "Ref": "HANAMasterHostname"
                                            },
                                            {
                                                "Ref": "DomainName"
                                            }
                                        ]
                                    ]
                                },
                                " > /etc/HOSTNAME\n",
                                "mkdir /root/install\n",
                                "wget https://s3.amazonaws.com/",
                                {
                                    "Ref": "PrivateBucket"
                                },
                                "/scripts/download.sh --output-document=/root/install/download.sh\n",
                                "sh /root/install/download.sh -b ",
                                {
                                    "Ref": "PrivateBucket"
                                },
                                "\n",
                                "chmod 755 /root/install/*.sh\n",
                                "chmod 755 /root/install/*.py\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "_",
                                        [
                                            "export TABLE_NAME=HANAMonitor_",
                                            {
                                                "Ref": "AWS::StackName"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export DeploymentInterruptQ=",
                                            {
                                                "Ref": "DeploymentInterruptQ"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export MyOS=",
                                            {
                                                "Fn::FindInMap": [
                                                    "SAPAMINameMap",
                                                    {
                                                        "Ref": "MyOS"
                                                    },
                                                    "Code"
                                                ]
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "sh /root/install/writeconfig.sh MyStackId=",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh INSTALL_HANA=",
                                {
                                    "Ref": "InstallHANA"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh HostCount=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh SAPInstanceNum=",
                                {
                                    "Ref": "SAPInstanceNum"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh IsMasterNode=1",
                                "\n",
                                "sh /root/install/writeconfig.sh IsWorkerNode=0",
                                "\n",
                                "sh /root/install/writeconfig.sh BACKUP_VOL=st1",
                                "\n",
                                "sh /root/install/writeconfig.sh SHARED_VOL=gp2",
                                "\n",
                                "sh /root/install/writeconfig.sh USR_SAP_VOL=gp2",
                                "\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "\"",
                                            "export WaitForMasterInstallWaitHandle=",
                                            "\\",
                                            "\"",
                                            {
                                                "Ref": "WaitForMasterInstallWaitHandle"
                                            },
                                            "\\",
                                            "\"",
                                            "\""
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export REGION=",
                                            {
                                                "Ref": "AWS::Region"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "sh /root/install/install-aws.sh\n",
                                "sh /root/install/install-prereq.sh\n",
                                "#sh /root/install/signal-complete.sh \n",
                                "sh /root/install/cluster-watch-engine.sh -c \n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "DomainName=",
                                {
                                    "Ref": "DomainName"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "MyHostname=",
                                {
                                    "Ref": "HANAMasterHostname"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "MyRole=Master",
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "HostCount=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "Status=PRE_INSTALL_COMPLETE",
                                "\"",
                                "\n",
                                "sh /root/install/reconcile-ips.sh ",
                                {
                                    "Ref": "HostCount"
                                },
                                " >> /root/install.log\n",
                                "sh /root/install/fence-cluster.sh -w \"PRE_INSTALL_COMPLETE_ACK=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/install-master.sh -s ",
                                {
                                    "Ref": "SID"
                                },
                                " -i ",
                                {
                                    "Ref": "SAPInstanceNum"
                                },
                                " -p ",
                                {
                                    "Ref": "HANAMasterPass"
                                },
                                " -n ",
                                {
                                    "Ref": "HANAMasterHostname"
                                },
                                " -d ",
                                {
                                    "Ref": "DomainName"
                                },
                                " -w ",
                                {
                                    "Ref": "HANAWorkerHostname"
                                },
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -s \"MASTER_NODE_COMPLETE\"\n",
                                "sh /root/install/wait-for-workers.sh ",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh  -r \n",
                                "sh /root/install/validate-install.sh \"",
                                {
                                    "Ref": "WaitForMasterInstallWaitHandle"
                                },
                                "\" \n",
                                "#python /root/install/postprocess.py \n",
                                "sh /root/install/cleanup.sh \n",
                                "\n",
                                "\n"
                            ]
                        ]
                    }
                },
                "InstanceType": {
                    "Ref": "MyInstanceType"
                }
            }
        },
        "PlacementGroup": {
            "Type": "AWS::EC2::PlacementGroup",
            "Properties": {
                "Strategy": "cluster"
            }
        },
        "HANAWorkerInstance1": {
            "Type": "AWS::EC2::Instance",
            "Condition": "TwoOrMoreNodes",
            "Metadata": {
                "HostRole": "Worker"
            },
            "Properties": {
                "NetworkInterfaces": [
                    {
                        "NetworkInterfaceId": {
                            "Ref": "HANAWorker1Interface"
                        },
                        "DeviceIndex": "0"
                    }
                ],
                "PlacementGroupName": {
                    "Fn::If": [
                        "PlacementGroupNull",
                        {
                            "Ref": "AWS::NoValue"
                        },
                        {
                            "Ref": "PlacementGroupName"
                        }
                    ]
                },
                "KeyName": {
                    "Ref": "KeyName"
                },
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "50",
                            "VolumeType": "gp2"
                        }
                    }
                ],
                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSAMIRegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        {
                            "Fn::FindInMap": [
                                "SAPAMINameMap",
                                {
                                    "Ref": "MyOS"
                                },
                                "Code"
                            ]
                        }
                    ]
                },
                "IamInstanceProfile": {
                    "Ref": "HANAIAMProfile"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "SAP HANA Worker 1"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -v\n",
                                "sudo su -c ",
                                "' ",
                                "\n",
                                "exec 3>&1 1>>/root/install/misc.log 2>&1 \n",
                                "hostname ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "01"
                                        ]
                                    ]
                                },
                                "\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "01"
                                        ]
                                    ]
                                },
                                " > /etc/HOSTNAME\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "01",
                                            ".",
                                            {
                                                "Ref": "DomainName"
                                            }
                                        ]
                                    ]
                                },
                                " > /etc/HOSTNAME\n",
                                "mkdir /root/install\n",
                                "wget https://s3.amazonaws.com/",
                                {
                                    "Ref": "PrivateBucket"
                                },
                                "/scripts/download.sh --output-document=/root/install/download.sh\n",
                                "sh /root/install/download.sh -b ",
                                {
                                    "Ref": "PrivateBucket"
                                },
                                "\n",
                                "chmod 755 /root/install/*.sh\n",
                                "chmod 755 /root/install/*.py\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "_",
                                        [
                                            "export TABLE_NAME=HANAMonitor_",
                                            {
                                                "Ref": "AWS::StackName"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export DeploymentInterruptQ=",
                                            {
                                                "Ref": "DeploymentInterruptQ"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export MyOS=",
                                            {
                                                "Fn::FindInMap": [
                                                    "SAPAMINameMap",
                                                    {
                                                        "Ref": "MyOS"
                                                    },
                                                    "Code"
                                                ]
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "sh /root/install/writeconfig.sh MyStackId=",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh INSTALL_HANA=",
                                {
                                    "Ref": "InstallHANA"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh HostCount=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh IsMasterNode=0",
                                "\n",
                                "sh /root/install/writeconfig.sh IsWorkerNode=1",
                                "\n",
                                "sh /root/install/writeconfig.sh USR_SAP_VOL=gp2",
                                "\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export REGION=",
                                            {
                                                "Ref": "AWS::Region"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "sh /root/install/install-aws.sh\n",
                                "sh /root/install/install-prereq.sh\n",
                                "sh /root/install/cluster-watch-engine.sh -c \n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "DomainName=",
                                {
                                    "Ref": "DomainName"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "MyHostname=",
                                {
                                    "Ref": "HANAWorkerHostname"
                                },
                                "01",
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "MyRole=Worker",
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "HostCount=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -s \"PRE_INSTALL_COMPLETE\"\n",
                                "sh /root/install/reconcile-ips.sh ",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "sh /root/install/fence-cluster.sh -w \"PRE_INSTALL_COMPLETE_ACK=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/wait-for-master.sh\n",
                                "sh /root/install/install-worker.sh -s ",
                                {
                                    "Ref": "SID"
                                },
                                " -p ",
                                {
                                    "Ref": "HANAMasterPass"
                                },
                                " -n ",
                                {
                                    "Ref": "HANAMasterHostname"
                                },
                                " -d ",
                                {
                                    "Ref": "DomainName"
                                },
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -s \"WORKER_NODE_COMPLETE\"\n",
                                "sh /root/install/wait-for-workers.sh ",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "#python /root/install/postprocess.py \n",
                                "sh /root/install/cleanup.sh ",
                                "\n",
                                "' ",
                                "\n"
                            ]
                        ]
                    }
                },
                "InstanceType": {
                    "Ref": "MyInstanceType"
                }
            }
        },
        "HANAWorkerInstance2": {
            "Type": "AWS::EC2::Instance",
            "Condition": "ThreeOrMoreNodes",
            "Metadata": {
                "HostRole": "Worker"
            },
            "Properties": {
                "NetworkInterfaces": [
                    {
                        "NetworkInterfaceId": {
                            "Ref": "HANAWorker2Interface"
                        },
                        "DeviceIndex": "0"
                    }
                ],
                "PlacementGroupName": {
                    "Fn::If": [
                        "PlacementGroupNull",
                        {
                            "Ref": "AWS::NoValue"
                        },
                        {
                            "Ref": "PlacementGroupName"
                        }
                    ]
                },
                "KeyName": {
                    "Ref": "KeyName"
                },
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "50",
                            "VolumeType": "gp2"
                        }
                    }
                ],
                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSAMIRegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        {
                            "Fn::FindInMap": [
                                "SAPAMINameMap",
                                {
                                    "Ref": "MyOS"
                                },
                                "Code"
                            ]
                        }
                    ]
                },
                "IamInstanceProfile": {
                    "Ref": "HANAIAMProfile"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "SAP HANA Worker 2"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -v\n",
                                "sudo su -c ",
                                "' ",
                                "\n",
                                "exec 3>&1 1>>/root/install/misc.log 2>&1 \n",
                                "hostname ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "02"
                                        ]
                                    ]
                                },
                                "\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "02"
                                        ]
                                    ]
                                },
                                " > /etc/HOSTNAME\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "02",
                                            ".",
                                            {
                                                "Ref": "DomainName"
                                            }
                                        ]
                                    ]
                                },
                                " > /etc/HOSTNAME\n",
                                "mkdir /root/install\n",
                                "wget https://s3.amazonaws.com/",
                                {
                                    "Ref": "PrivateBucket"
                                },
                                "/scripts/download.sh --output-document=/root/install/download.sh\n",
                                "sh /root/install/download.sh -b ",
                                {
                                    "Ref": "PrivateBucket"
                                },
                                "\n",
                                "chmod 755 /root/install/*.sh\n",
                                "chmod 755 /root/install/*.py\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "_",
                                        [
                                            "export TABLE_NAME=HANAMonitor_",
                                            {
                                                "Ref": "AWS::StackName"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export DeploymentInterruptQ=",
                                            {
                                                "Ref": "DeploymentInterruptQ"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export MyOS=",
                                            {
                                                "Fn::FindInMap": [
                                                    "SAPAMINameMap",
                                                    {
                                                        "Ref": "MyOS"
                                                    },
                                                    "Code"
                                                ]
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "sh /root/install/writeconfig.sh MyStackId=",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh INSTALL_HANA=",
                                {
                                    "Ref": "InstallHANA"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh HostCount=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh IsMasterNode=0",
                                "\n",
                                "sh /root/install/writeconfig.sh IsWorkerNode=1",
                                "\n",
                                "sh /root/install/writeconfig.sh USR_SAP_VOL=gp2",
                                "\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export REGION=",
                                            {
                                                "Ref": "AWS::Region"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "sh /root/install/install-aws.sh\n",
                                "sh /root/install/install-prereq.sh\n",
                                "sh /root/install/cluster-watch-engine.sh -c \n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "DomainName=",
                                {
                                    "Ref": "DomainName"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "MyHostname=",
                                {
                                    "Ref": "HANAWorkerHostname"
                                },
                                "02",
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "MyRole=Worker",
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "HostCount=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -s \"PRE_INSTALL_COMPLETE\"\n",
                                "sh /root/install/reconcile-ips.sh ",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "sh /root/install/fence-cluster.sh -w \"PRE_INSTALL_COMPLETE_ACK=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/wait-for-master.sh\n",
                                "sh /root/install/install-worker.sh -s ",
                                {
                                    "Ref": "SID"
                                },
                                " -p ",
                                {
                                    "Ref": "HANAMasterPass"
                                },
                                " -n ",
                                {
                                    "Ref": "HANAMasterHostname"
                                },
                                " -d ",
                                {
                                    "Ref": "DomainName"
                                },
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -s \"WORKER_NODE_COMPLETE\"\n",
                                "sh /root/install/wait-for-workers.sh ",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "#python /root/install/postprocess.py \n",
                                "sh /root/install/cleanup.sh ",
                                "\n",
                                "' ",
                                "\n"
                            ]
                        ]
                    }
                },
                "InstanceType": {
                    "Ref": "MyInstanceType"
                }
            }
        },
        "HANAWorkerInstance3": {
            "Type": "AWS::EC2::Instance",
            "Condition": "FourOrMoreNodes",
            "Metadata": {
                "HostRole": "Worker"
            },
            "Properties": {
                "NetworkInterfaces": [
                    {
                        "NetworkInterfaceId": {
                            "Ref": "HANAWorker3Interface"
                        },
                        "DeviceIndex": "0"
                    }
                ],
                "PlacementGroupName": {
                    "Fn::If": [
                        "PlacementGroupNull",
                        {
                            "Ref": "AWS::NoValue"
                        },
                        {
                            "Ref": "PlacementGroupName"
                        }
                    ]
                },
                "KeyName": {
                    "Ref": "KeyName"
                },
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "50",
                            "VolumeType": "gp2"
                        }
                    }
                ],
                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSAMIRegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        {
                            "Fn::FindInMap": [
                                "SAPAMINameMap",
                                {
                                    "Ref": "MyOS"
                                },
                                "Code"
                            ]
                        }
                    ]
                },
                "IamInstanceProfile": {
                    "Ref": "HANAIAMProfile"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "SAP HANA Worker 3"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -v\n",
                                "sudo su -c ",
                                "' ",
                                "\n",
                                "exec 3>&1 1>>/root/install/misc.log 2>&1 \n",
                                "hostname ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "03"
                                        ]
                                    ]
                                },
                                "\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "03"
                                        ]
                                    ]
                                },
                                " > /etc/HOSTNAME\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "03",
                                            ".",
                                            {
                                                "Ref": "DomainName"
                                            }
                                        ]
                                    ]
                                },
                                " > /etc/HOSTNAME\n",
                                "mkdir /root/install\n",
                                "wget https://s3.amazonaws.com/",
                                {
                                    "Ref": "PrivateBucket"
                                },
                                "/scripts/download.sh --output-document=/root/install/download.sh\n",
                                "sh /root/install/download.sh -b ",
                                {
                                    "Ref": "PrivateBucket"
                                },
                                "\n",
                                "chmod 755 /root/install/*.sh\n",
                                "chmod 755 /root/install/*.py\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "_",
                                        [
                                            "export TABLE_NAME=HANAMonitor_",
                                            {
                                                "Ref": "AWS::StackName"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export DeploymentInterruptQ=",
                                            {
                                                "Ref": "DeploymentInterruptQ"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export MyOS=",
                                            {
                                                "Fn::FindInMap": [
                                                    "SAPAMINameMap",
                                                    {
                                                        "Ref": "MyOS"
                                                    },
                                                    "Code"
                                                ]
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "sh /root/install/writeconfig.sh MyStackId=",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh INSTALL_HANA=",
                                {
                                    "Ref": "InstallHANA"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh HostCount=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh IsMasterNode=0",
                                "\n",
                                "sh /root/install/writeconfig.sh IsWorkerNode=1",
                                "\n",
                                "sh /root/install/writeconfig.sh USR_SAP_VOL=gp2",
                                "\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export REGION=",
                                            {
                                                "Ref": "AWS::Region"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "sh /root/install/install-aws.sh\n",
                                "sh /root/install/install-prereq.sh\n",
                                "sh /root/install/cluster-watch-engine.sh -c \n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "DomainName=",
                                {
                                    "Ref": "DomainName"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "MyHostname=",
                                {
                                    "Ref": "HANAWorkerHostname"
                                },
                                "03",
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "MyRole=Worker",
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "HostCount=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -s \"PRE_INSTALL_COMPLETE\"\n",
                                "sh /root/install/reconcile-ips.sh ",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "sh /root/install/fence-cluster.sh -w \"PRE_INSTALL_COMPLETE_ACK=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/wait-for-master.sh\n",
                                "sh /root/install/install-worker.sh -s ",
                                {
                                    "Ref": "SID"
                                },
                                " -p ",
                                {
                                    "Ref": "HANAMasterPass"
                                },
                                " -n ",
                                {
                                    "Ref": "HANAMasterHostname"
                                },
                                " -d ",
                                {
                                    "Ref": "DomainName"
                                },
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -s \"WORKER_NODE_COMPLETE\"\n",
                                "sh /root/install/wait-for-workers.sh ",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "#python /root/install/postprocess.py \n",
                                "sh /root/install/cleanup.sh ",
                                "\n",
                                "' ",
                                "\n"
                            ]
                        ]
                    }
                },
                "InstanceType": {
                    "Ref": "MyInstanceType"
                }
            }
        },
        "HANAWorkerInstance4": {
            "Type": "AWS::EC2::Instance",
            "Condition": "FiveOrMoreNodes",
            "Metadata": {
                "HostRole": "Worker"
            },
            "Properties": {
                "NetworkInterfaces": [
                    {
                        "NetworkInterfaceId": {
                            "Ref": "HANAWorker4Interface"
                        },
                        "DeviceIndex": "0"
                    }
                ],
                "PlacementGroupName": {
                    "Fn::If": [
                        "PlacementGroupNull",
                        {
                            "Ref": "AWS::NoValue"
                        },
                        {
                            "Ref": "PlacementGroupName"
                        }
                    ]
                },
                "KeyName": {
                    "Ref": "KeyName"
                },
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "50",
                            "VolumeType": "gp2"
                        }
                    }
                ],
                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSAMIRegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        {
                            "Fn::FindInMap": [
                                "SAPAMINameMap",
                                {
                                    "Ref": "MyOS"
                                },
                                "Code"
                            ]
                        }
                    ]
                },
                "IamInstanceProfile": {
                    "Ref": "HANAIAMProfile"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "SAP HANA Worker 4"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -v\n",
                                "sudo su -c ",
                                "' ",
                                "\n",
                                "exec 3>&1 1>>/root/install/misc.log 2>&1 \n",
                                "hostname ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "04"
                                        ]
                                    ]
                                },
                                "\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "04"
                                        ]
                                    ]
                                },
                                " > /etc/HOSTNAME\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "04",
                                            ".",
                                            {
                                                "Ref": "DomainName"
                                            }
                                        ]
                                    ]
                                },
                                " > /etc/HOSTNAME\n",
                                "mkdir /root/install\n",
                                "wget https://s3.amazonaws.com/",
                                {
                                    "Ref": "PrivateBucket"
                                },
                                "/scripts/download.sh --output-document=/root/install/download.sh\n",
                                "sh /root/install/download.sh -b ",
                                {
                                    "Ref": "PrivateBucket"
                                },
                                "\n",
                                "chmod 755 /root/install/*.sh\n",
                                "chmod 755 /root/install/*.py\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "_",
                                        [
                                            "export TABLE_NAME=HANAMonitor_",
                                            {
                                                "Ref": "AWS::StackName"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export DeploymentInterruptQ=",
                                            {
                                                "Ref": "DeploymentInterruptQ"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export MyOS=",
                                            {
                                                "Fn::FindInMap": [
                                                    "SAPAMINameMap",
                                                    {
                                                        "Ref": "MyOS"
                                                    },
                                                    "Code"
                                                ]
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "sh /root/install/writeconfig.sh MyStackId=",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh INSTALL_HANA=",
                                {
                                    "Ref": "InstallHANA"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh HostCount=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh IsMasterNode=0",
                                "\n",
                                "sh /root/install/writeconfig.sh IsWorkerNode=1",
                                "\n",
                                "sh /root/install/writeconfig.sh USR_SAP_VOL=gp2",
                                "\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export REGION=",
                                            {
                                                "Ref": "AWS::Region"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "sh /root/install/install-aws.sh\n",
                                "sh /root/install/install-prereq.sh\n",
                                "sh /root/install/cluster-watch-engine.sh -c \n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "DomainName=",
                                {
                                    "Ref": "DomainName"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "MyHostname=",
                                {
                                    "Ref": "HANAWorkerHostname"
                                },
                                "04",
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "MyRole=Worker",
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "HostCount=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -s \"PRE_INSTALL_COMPLETE\"\n",
                                "sh /root/install/reconcile-ips.sh ",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "sh /root/install/fence-cluster.sh -w \"PRE_INSTALL_COMPLETE_ACK=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/wait-for-master.sh\n",
                                "sh /root/install/install-worker.sh -s ",
                                {
                                    "Ref": "SID"
                                },
                                " -p ",
                                {
                                    "Ref": "HANAMasterPass"
                                },
                                " -n ",
                                {
                                    "Ref": "HANAMasterHostname"
                                },
                                " -d ",
                                {
                                    "Ref": "DomainName"
                                },
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -s \"WORKER_NODE_COMPLETE\"\n",
                                "sh /root/install/wait-for-workers.sh ",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "#python /root/install/postprocess.py \n",
                                "sh /root/install/cleanup.sh ",
                                "\n",
                                "' ",
                                "\n"
                            ]
                        ]
                    }
                },
                "InstanceType": {
                    "Ref": "MyInstanceType"
                }
            }
        },
        "HANAWorkerInstance5": {
            "Type": "AWS::EC2::Instance",
            "Condition": "SixOrMoreNodes",
            "Metadata": {
                "HostRole": "Worker"
            },
            "Properties": {
                "NetworkInterfaces": [
                    {
                        "NetworkInterfaceId": {
                            "Ref": "HANAWorker5Interface"
                        },
                        "DeviceIndex": "0"
                    }
                ],
                "PlacementGroupName": {
                    "Fn::If": [
                        "PlacementGroupNull",
                        {
                            "Ref": "AWS::NoValue"
                        },
                        {
                            "Ref": "PlacementGroupName"
                        }
                    ]
                },
                "KeyName": {
                    "Ref": "KeyName"
                },
                "BlockDeviceMappings": [
                    {
                        "DeviceName": "/dev/sda1",
                        "Ebs": {
                            "VolumeSize": "50",
                            "VolumeType": "gp2"
                        }
                    }
                ],
                "ImageId": {
                    "Fn::FindInMap": [
                        "AWSAMIRegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        {
                            "Fn::FindInMap": [
                                "SAPAMINameMap",
                                {
                                    "Ref": "MyOS"
                                },
                                "Code"
                            ]
                        }
                    ]
                },
                "IamInstanceProfile": {
                    "Ref": "HANAIAMProfile"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "SAP HANA Worker 5"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -v\n",
                                "sudo su -c ",
                                "' ",
                                "\n",
                                "exec 3>&1 1>>/root/install/misc.log 2>&1 \n",
                                "hostname ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "05"
                                        ]
                                    ]
                                },
                                "\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "05"
                                        ]
                                    ]
                                },
                                " > /etc/HOSTNAME\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            {
                                                "Ref": "HANAWorkerHostname"
                                            },
                                            "05",
                                            ".",
                                            {
                                                "Ref": "DomainName"
                                            }
                                        ]
                                    ]
                                },
                                " > /etc/HOSTNAME\n",
                                "mkdir /root/install\n",
                                "wget https://s3.amazonaws.com/",
                                {
                                    "Ref": "PrivateBucket"
                                },
                                "/scripts/download.sh --output-document=/root/install/download.sh\n",
                                "sh /root/install/download.sh -b ",
                                {
                                    "Ref": "PrivateBucket"
                                },
                                "\n",
                                "chmod 755 /root/install/*.sh\n",
                                "chmod 755 /root/install/*.py\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "_",
                                        [
                                            "export TABLE_NAME=HANAMonitor_",
                                            {
                                                "Ref": "AWS::StackName"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export DeploymentInterruptQ=",
                                            {
                                                "Ref": "DeploymentInterruptQ"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export MyOS=",
                                            {
                                                "Fn::FindInMap": [
                                                    "SAPAMINameMap",
                                                    {
                                                        "Ref": "MyOS"
                                                    },
                                                    "Code"
                                                ]
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "sh /root/install/writeconfig.sh MyStackId=",
                                {
                                    "Ref": "AWS::StackId"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh INSTALL_HANA=",
                                {
                                    "Ref": "InstallHANA"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh HostCount=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "sh /root/install/writeconfig.sh IsMasterNode=0",
                                "\n",
                                "sh /root/install/writeconfig.sh IsWorkerNode=1",
                                "\n",
                                "sh /root/install/writeconfig.sh USR_SAP_VOL=gp2",
                                "\n",
                                "echo ",
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "export REGION=",
                                            {
                                                "Ref": "AWS::Region"
                                            }
                                        ]
                                    ]
                                },
                                " >> /root/install/config.sh\n",
                                "sh /root/install/install-aws.sh\n",
                                "sh /root/install/install-prereq.sh\n",
                                "sh /root/install/cluster-watch-engine.sh -c \n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "DomainName=",
                                {
                                    "Ref": "DomainName"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "MyHostname=",
                                {
                                    "Ref": "HANAWorkerHostname"
                                },
                                "05",
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "MyRole=Worker",
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -i ",
                                "\"",
                                "HostCount=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -s \"PRE_INSTALL_COMPLETE\"\n",
                                "sh /root/install/reconcile-ips.sh ",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "sh /root/install/fence-cluster.sh -w \"PRE_INSTALL_COMPLETE_ACK=",
                                {
                                    "Ref": "HostCount"
                                },
                                "\"",
                                "\n",
                                "sh /root/install/wait-for-master.sh\n",
                                "sh /root/install/install-worker.sh -s ",
                                {
                                    "Ref": "SID"
                                },
                                " -p ",
                                {
                                    "Ref": "HANAMasterPass"
                                },
                                " -n ",
                                {
                                    "Ref": "HANAMasterHostname"
                                },
                                " -d ",
                                {
                                    "Ref": "DomainName"
                                },
                                "\n",
                                "sh /root/install/cluster-watch-engine.sh -s \"WORKER_NODE_COMPLETE\"\n",
                                "sh /root/install/wait-for-workers.sh ",
                                {
                                    "Ref": "HostCount"
                                },
                                "\n",
                                "#python /root/install/postprocess.py \n",
                                "sh /root/install/cleanup.sh ",
                                "\n",
                                "' ",
                                "\n"
                            ]
                        ]
                    }
                },
                "InstanceType": {
                    "Ref": "MyInstanceType"
                }
            }
        },
        "AutoRecoverAlarmMaster": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "AutoRecoveryMaster",
            "Properties": {
                "AlarmDescription": "Trigger a recovery when instance status check fails for 5 consecutive minute.",
                "Namespace": "AWS/EC2",
                "MetricName": "StatusCheckFailed_System",
                "Statistic": "Minimum",
                "Period": "60",
                "EvaluationPeriods": "5",
                "ComparisonOperator": "GreaterThanThreshold",
                "Threshold": "0",
                "AlarmActions": [
                    {
                        "Fn::Join": [
                            "",
                            [
                                "arn:aws:automate:",
                                {
                                    "Ref": "AWS::Region"
                                },
                                ":ec2:recover"
                            ]
                        ]
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "InstanceId",
                        "Value": {
                            "Ref": "HANAMasterInstance"
                        }
                    }
                ]
            }
        },
        "AutoRecoverAlarmWorker1": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "AutoRecoveryWorker1",
            "Properties": {
                "AlarmDescription": "Trigger a recovery when instance status check fails for 5 consecutive minutes.",
                "Namespace": "AWS/EC2",
                "MetricName": "StatusCheckFailed_System",
                "Statistic": "Minimum",
                "Period": "60",
                "EvaluationPeriods": "5",
                "ComparisonOperator": "GreaterThanThreshold",
                "Threshold": "0",
                "AlarmActions": [
                    {
                        "Fn::Join": [
                            "",
                            [
                                "arn:aws:automate:",
                                {
                                    "Ref": "AWS::Region"
                                },
                                ":ec2:recover"
                            ]
                        ]
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "InstanceId",
                        "Value": {
                            "Ref": "HANAWorkerInstance1"
                        }
                    }
                ]
            }
        },
        "AutoRecoverAlarmWorker2": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "AutoRecoveryWorker2",
            "Properties": {
                "AlarmDescription": "Trigger a recovery when instance status check fails for 5 consecutive minutes.",
                "Namespace": "AWS/EC2",
                "MetricName": "StatusCheckFailed_System",
                "Statistic": "Minimum",
                "Period": "60",
                "EvaluationPeriods": "5",
                "ComparisonOperator": "GreaterThanThreshold",
                "Threshold": "0",
                "AlarmActions": [
                    {
                        "Fn::Join": [
                            "",
                            [
                                "arn:aws:automate:",
                                {
                                    "Ref": "AWS::Region"
                                },
                                ":ec2:recover"
                            ]
                        ]
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "InstanceId",
                        "Value": {
                            "Ref": "HANAWorkerInstance2"
                        }
                    }
                ]
            }
        },
        "AutoRecoverAlarmWorker3": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "AutoRecoveryWorker3",
            "Properties": {
                "AlarmDescription": "Trigger a recovery when instance status check fails for 5 consecutive minutes.",
                "Namespace": "AWS/EC2",
                "MetricName": "StatusCheckFailed_System",
                "Statistic": "Minimum",
                "Period": "60",
                "EvaluationPeriods": "5",
                "ComparisonOperator": "GreaterThanThreshold",
                "Threshold": "0",
                "AlarmActions": [
                    {
                        "Fn::Join": [
                            "",
                            [
                                "arn:aws:automate:",
                                {
                                    "Ref": "AWS::Region"
                                },
                                ":ec2:recover"
                            ]
                        ]
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "InstanceId",
                        "Value": {
                            "Ref": "HANAWorkerInstance3"
                        }
                    }
                ]
            }
        },
        "AutoRecoverAlarmWorker4": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "AutoRecoveryWorker4",
            "Properties": {
                "AlarmDescription": "Trigger a recovery when instance status check fails for 5 consecutive minutes.",
                "Namespace": "AWS/EC2",
                "MetricName": "StatusCheckFailed_System",
                "Statistic": "Minimum",
                "Period": "60",
                "EvaluationPeriods": "5",
                "ComparisonOperator": "GreaterThanThreshold",
                "Threshold": "0",
                "AlarmActions": [
                    {
                        "Fn::Join": [
                            "",
                            [
                                "arn:aws:automate:",
                                {
                                    "Ref": "AWS::Region"
                                },
                                ":ec2:recover"
                            ]
                        ]
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "InstanceId",
                        "Value": {
                            "Ref": "HANAWorkerInstance4"
                        }
                    }
                ]
            }
        },
        "AutoRecoverAlarmWorker5": {
            "Type": "AWS::CloudWatch::Alarm",
            "Condition": "AutoRecoveryWorker5",
            "Properties": {
                "AlarmDescription": "Trigger a recovery when instance status check fails for 5 consecutive minutes.",
                "Namespace": "AWS/EC2",
                "MetricName": "StatusCheckFailed_System",
                "Statistic": "Minimum",
                "Period": "60",
                "EvaluationPeriods": "5",
                "ComparisonOperator": "GreaterThanThreshold",
                "Threshold": "0",
                "AlarmActions": [
                    {
                        "Fn::Join": [
                            "",
                            [
                                "arn:aws:automate:",
                                {
                                    "Ref": "AWS::Region"
                                },
                                ":ec2:recover"
                            ]
                        ]
                    }
                ],
                "Dimensions": [
                    {
                        "Name": "InstanceId",
                        "Value": {
                            "Ref": "HANAWorkerInstance5"
                        }
                    }
                ]
            }
        }
    }
}